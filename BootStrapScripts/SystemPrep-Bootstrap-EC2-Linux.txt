#!/bin/bash
set -ex

#User variables
SYSTEMPREPMASTERSCRIPTURL="https://systemprep.s3.amazonaws.com/MasterScripts/SystemPrep-LinuxMaster.sh"

#These are the system params for the MasterScript
declare -a SYSTEMPREPPARAMS=(MemberServer Unclass Highstate FALSE)

# system variables
CURL="/usr/bin/curl"
LOGGER="/bin/logger"
SYSTEMPREPDIR=/var/tmp/systemprep

#not currently used
SYSTEMPREPLOGFILE=/var/log/systemprep

#validate logger exists
if [ ! -x ${LOGGER} ]; then
	echo "Can't find ${LOGGER}"
	exit 5
fi

#validate curl exists
if [ ! -x ${CURL} ]; then
	logger "Can't find ${CURL}"
	exit 6
fi

#validate system prep directory exists
if [ ! -d ${SYSTEMPREPDIR} ]; then 
  logger "Creating ${SYSTEMPREPDIR} directory."
  mkdir $SYSTEMPREPDIR 2>&1 | logger 
fi

#not currently used
#if [ ! -f ${SYSTEMPREPLOGFILE} ]; then
#   logger "Creating ${SYSTEMPREPLOGFILE}."
#   touch -f ${SYSTEMPREPLOGFILE} >2&1 | logger
#fi

# change working directory and grab the script
logger "Grabbing ${SYSTEMPREPMASTERSCRIPTURL} and placing it in ${SYSTEMPREPDIR}"
cd ${SYSTEMPREPDIR} && ${CURL} -# -O ${SYSTEMPREPMASTERSCRIPTURL} 2>&1 | logger

# tokenize SYSTEMPREPMASTERSCRIPTURL
IFS='/'; for WORD in ${SYSTEMPREPMASTERSCRIPTURL}; do SCRIPT=${WORD}; done

# make script executable
logger "Changing permissions to 700 on ${SYSTEMPREPDIR}/${SCRIPT}"
chmod 700 "${SYSTEMPREPDIR}/${SCRIPT}" 2>&1 | logger

# execute the script passing the parameters
logger "Executing ${SYSTEMPREPDIR}/${SCRIPT} ${SYSTEMPREPPARAMS[*]}."
source "${SYSTEMPREPDIR}/${SCRIPT} ${SYSTEMPREPPARAMS[*]}"

